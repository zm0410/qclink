<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="description" content="CSV é©±åŠ¨çš„é™æ€å¯¼èˆªç«™ï¼Œæ”¯æŒå¤šçº§åˆ†ç±»ã€å¤œé—´æ¨¡å¼ï¼Œç°ä»£æ‰å¹³åŒ–ç•Œé¢ã€‚"/>
  <title>ç°ä»£å¯¼èˆªç«™ - æ‰å¹³åŒ–è®¾è®¡</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div id="loading" class="loading-overlay">
  <div class="spinner"></div>
  <p>åŠ è½½ä¸­...</p>
</div>

<header>
  <h1>ç°ä»£å¯¼èˆªç«™</h1>
  <button id="themeBtn" aria-label="åˆ‡æ¢å¤œé—´æ¨¡å¼">ğŸŒ™</button>
</header>

<main>
  <nav id="side"></nav>
  <section>
    <h2 id="subTitle">è¯·é€‰æ‹©åˆ†ç±»</h2>
    <div id="list" class="site-grid"></div>
  </section>
</main>

<script>
/* ===== å¤œé—´æ¨¡å¼ ===== */
const body = document.body;
const themeBtn = document.getElementById('themeBtn');
if (localStorage.getItem('theme') === 'dark') body.classList.add('dark');
themeBtn.addEventListener('click', () => {
  body.classList.toggle('dark');
  localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : '');
  themeBtn.textContent = body.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
  // æ·»åŠ æŒ‰é’®ç‚¹å‡»åŠ¨ç”»
  themeBtn.classList.add('rotating');
  setTimeout(() => themeBtn.classList.remove('rotating'), 300);
});

/* ===== CSV è§£æï¼ˆæ”¯æŒå¤šçº§åˆ†ç±»ï¼‰ ===== */
async function loadCSV() {
  const text = await fetch('data.csv').then(r => r.text());
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',');
  const data = lines.slice(1).map(l => {
    const vals = l.split(',');
    return headers.reduce((obj, h, i) => (obj[h] = vals[i], obj), {});
  });

  // æ„å»ºåˆ†ç±»æ ‘ç»“æ„
  const root = { name: 'root', children: {}, sites: [] };
  
  for (const row of data) {
    const { åç§°, ç½‘å€, æè¿°, å›¾æ ‡, ç±»åˆ«1, ç±»åˆ«2, ç±»åˆ«3, ç±»åˆ«4, ç±»åˆ«5 } = row;
    
    // åªå¤„ç†åŒ…å«ç«™ç‚¹ä¿¡æ¯çš„è¡Œ
    if (åç§° && ç½‘å€) {
      // æ„å»ºåˆ†ç±»è·¯å¾„
      const categories = [ç±»åˆ«1, ç±»åˆ«2, ç±»åˆ«3, ç±»åˆ«4, ç±»åˆ«5].filter(cat => cat && cat.trim() !== '');
      
      // å¯¼èˆªåˆ°å¯¹åº”åˆ†ç±»èŠ‚ç‚¹
      let currentNode = root;
      for (const category of categories) {
        if (!currentNode.children[category]) {
          currentNode.children[category] = { 
            name: category, 
            children: {}, 
            sites: [] 
          };
        }
        currentNode = currentNode.children[category];
      }
      
      // æ·»åŠ ç«™ç‚¹åˆ°æœ€ç»ˆåˆ†ç±»
      currentNode.sites.push({ 
        name: åç§°, 
        url: ç½‘å€, 
        desc: æè¿°, 
        icon: å›¾æ ‡ 
      });
    }
  }
  
  // è½¬æ¢ä¸ºæ•°ç»„ç»“æ„
  function convertToArray(node) {
    if (!node.children) return [];
    
    return Object.values(node.children).map(child => {
      return {
        name: child.name,
        children: convertToArray(child),
        sites: child.sites || []
      };
    });
  }
  
  return convertToArray(root);
}

/* ===== é€’å½’æ ‘ï¼ˆç§»é™¤ç®­å¤´ï¼‰ ===== */
function buildTree(arr, parentKey = '', level = 0) {
  let html = '';
  arr.forEach((node, idx) => {
    const key = parentKey ? `${parentKey}-${idx}` : `${idx}`;
    const hasSub = node.children && node.children.length;
    const hasSites = node.sites && node.sites.length;

    html += `
      <div class="nav-item">
        <div class="nav-row"
             data-level="${level}"
             data-key="${key}"
             data-name="${node.name}"
             data-container="${hasSub ? 'children' : 'sites'}"
             ${hasSites ? `data-sites='${JSON.stringify(node.sites)}'` : ''}>
          <span class="nav-icon">ğŸ“</span>
          <span>${node.name}</span>
        </div>`;

    if (hasSub) {
      html += `<div class="nav-children" data-parent="${key}">
                 ${buildTree(node.children, key, level + 1)}
               </div>`;
    }
    html += `</div>`;
  });
  return html;
}

/* ===== å³ä¾§å¡ç‰‡ ===== */
function showSites(title, sites) {
  document.getElementById('subTitle').textContent = title;
  const box = document.getElementById('list');
  if (!sites.length) { 
    box.innerHTML = '<p style="color:#999;text-align:center;width:100%;">æš‚æ— ç«™ç‚¹</p>'; 
    return; 
  }
  box.innerHTML = sites.map(s => `
    <a class="site-card" href="${s.url}" target="_blank" rel="noopener">
      <div class="site-icon">${s.icon || 'ğŸŒ'}</div>
      <div class="site-name">${s.name}</div>
      <div class="site-desc">${s.desc || ''}</div>
    </a>`).join('');
}

/* ===== å…¥å£ ===== */
// æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
const loadingOverlay = document.getElementById('loading');

loadCSV().then(data => {
  document.getElementById('side').innerHTML = buildTree(data);
  // éšè—åŠ è½½åŠ¨ç”»
  loadingOverlay.classList.add('hidden');

  document.getElementById('side').addEventListener('click', e => {
    const row = e.target.closest('.nav-row');
    if (!row) return;

    /* ä¸€çº§æŠ˜å /å±•å¼€ */
    const children = row.nextElementSibling;
    if (children && children.classList.contains('nav-children')) {
      children.classList.toggle('open');
      // æ·»åŠ å±•å¼€åŠ¨ç”»
      if (children.classList.contains('open')) {
        children.style.maxHeight = children.scrollHeight + 'px';
      } else {
        children.style.maxHeight = '0';
      }
    }

    /* é€‰ä¸­å¹¶å±•ç¤ºå³ä¾§ */
    document.querySelectorAll('.nav-row').forEach(r => r.classList.remove('active'));
    row.classList.add('active');
    const sites = JSON.parse(row.dataset.sites || '[]');
    showSites(row.dataset.name, sites);
  });
});
</script>
</body>
</html>